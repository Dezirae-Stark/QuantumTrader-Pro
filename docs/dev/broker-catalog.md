# Broker Catalog Architecture

Developer guide for the QuantumTrader Pro dynamic broker catalog system.

## ğŸ“ Architecture Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Android App                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Embedded    â”‚  â”‚    Cached    â”‚  â”‚     Remote       â”‚  â”‚
â”‚  â”‚  brokers.jsonâ”‚â—„â”€â”¤  brokers.jsonâ”‚â—„â”€â”¤  brokers.json    â”‚  â”‚
â”‚  â”‚  (assets/)   â”‚  â”‚  (cache/)    â”‚  â”‚  + signature     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚         â–²                 â–²                    â–²             â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                           â”‚                                  â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”                           â”‚
â”‚                    â”‚BrokerCatalogâ”‚                           â”‚
â”‚                    â”‚   Loader    â”‚                           â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                           â”‚
â”‚                           â”‚                                  â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚
â”‚              â”‚  Signature Verification â”‚                     â”‚
â”‚              â”‚  (Ed25519)              â”‚                     â”‚
â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
â”‚                           â”‚                                  â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”                           â”‚
â”‚                    â”‚    UI        â”‚                           â”‚
â”‚                    â”‚  Broker List â”‚                           â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â–²
                           â”‚ HTTPS
                           â”‚ (signature verified)
                           â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           GitHub Pages (QuantumTrader-Pro-data)            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚brokers.json  â”‚  â”‚brokers.json  â”‚  â”‚catalog_metadata â”‚  â”‚
â”‚  â”‚              â”‚  â”‚.sig          â”‚  â”‚.json            â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                             â”‚
â”‚  Generated by: publish-brokers.yml workflow                â”‚
â”‚  Signed with: Ed25519 private key (GitHub Secrets)         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ—ï¸ Component Overview

### 1. Data Model (`Broker.kt`)

Represents a single broker configuration:

```kotlin
data class Broker(
    val name: String,
    val server: String,
    val platform: String,  // "MT4" or "MT5"
    val webTerminalUrl: String,  // HTTPS required
    val logo: String? = null,
    val description: String? = null,
    val demo: Boolean = false
)
```

**Validation Rules:**
- `name`: Non-empty, 1-100 chars
- `server`: Non-empty, 1-200 chars
- `platform`: Must be "MT4" or "MT5"
- `webTerminalUrl`: Must start with "https://"

### 2. Schema Validator (`BrokerSchema.kt`)

Validates JSON against the schema:

```kotlin
object BrokerSchema {
    fun validateAndParse(jsonString: String): List<Broker>?
    fun isValid(jsonString: String): Boolean
    fun getValidationError(jsonString: String): String?
}
```

**Schema Location:** `docs/brokers.schema.json`

### 3. Signature Verifier (`SignatureVerifier.kt`)

Verifies Ed25519 signatures:

```kotlin
object SignatureVerifier {
    fun verify(data: ByteArray, signatureBase64: String): Boolean
    fun verifySignatureFile(data: ByteArray, signatureFileContent: String): Boolean
}
```

**Key Management:**
- Public key embedded in app (compile-time constant)
- Supports backup key for rotation
- Verifies minisign-format signatures

**âš ï¸ IMPORTANT**: The current implementation uses a placeholder. For production:

1. Add Lazysodium dependency: âœ… Already in build.gradle
2. Replace placeholder with real Ed25519 verification
3. Generate and embed actual public key

### 4. Catalog Loader (`BrokerCatalog.kt`)

Manages catalog loading with fallback strategy:

```kotlin
class BrokerCatalog(context: Context) {
    fun loadCatalog(): List<Broker>                    // Sync: cache â†’ embedded
    fun loadEmbedded(): List<Broker>                   // Load from assets
    fun loadCached(): List<Broker>?                    // Load from cache
    suspend fun fetchAndVerify(): List<Broker>?        // Fetch remote
    fun saveCached(json: String, etag: String?)        // Save to cache
    fun shouldUpdate(): Boolean                        // Check if update needed
}
```

**Loading Strategy:**

1. **Synchronous Init** (UI startup):
   - Try cached catalog (if < 1 week old)
   - Fall back to embedded assets

2. **Asynchronous Update** (background):
   - Fetch from GitHub Pages
   - Verify signature
   - Validate schema
   - Save to cache atomically

3. **Offline Resilience**:
   - Embedded catalog always available
   - Cache survives app restarts
   - Network failures don't break UX

### 5. Background Updater (`BrokerUpdater.kt`)

WorkManager-based background sync:

```kotlin
class BrokerUpdateWorker : CoroutineWorker {
    // Runs periodically via WorkManager
}

class BrokerUpdateManager(context: Context) {
    fun setAutoUpdateEnabled(enabled: Boolean)
    fun updateNow(): OneTimeWorkRequest
    fun getLastUpdateTimestamp(): Long
}
```

**Update Schedule:**
- Periodic: Every 7 days
- Constraints: Connected network, battery not low
- Retry: Exponential backoff on failure
- Manual: User-triggered from Settings

### 6. UI Components

**Adapter** (`BrokerListAdapter.kt`):
- RecyclerView adapter with DiffUtil
- Search and filter support
- Material Design 3 cards

**Filter** (`BrokerFilter`):
```kotlin
BrokerFilter.filter(
    brokers = allBrokers,
    query = "LHFX",
    platform = "MT4",
    demoOnly = false
)
```

## ğŸ”„ Update Flow

### User-Initiated Update

```
User taps "Update Now"
        â”‚
        â–¼
BrokerUpdateManager.updateNow()
        â”‚
        â–¼
WorkManager enqueues task
        â”‚
        â–¼
BrokerUpdateWorker.doWork()
        â”‚
        â”œâ”€â†’ Fetch brokers.json
        â”œâ”€â†’ Fetch brokers.json.sig
        â”œâ”€â†’ Verify signature
        â”œâ”€â†’ Validate schema
        â””â”€â†’ Save to cache
                â”‚
                â–¼
        UI observes WorkInfo
                â”‚
                â–¼
        Show success/error toast
```

### Automatic Background Update

```
WorkManager scheduler (weekly)
        â”‚
        â–¼
Check constraints (network, battery)
        â”‚
        â–¼
BrokerUpdateWorker.doWork()
        â”‚
        â”œâ”€â†’ Check if update needed (shouldUpdate())
        â”œâ”€â†’ Fetch and verify
        â””â”€â†’ Update cache silently
```

## ğŸ” Security Implementation

### Signature Verification

**Format**: minisign

**Process**:
1. Fetch `brokers.json` and `brokers.json.sig`
2. Parse signature file (3 lines: comment, sig, trusted comment)
3. Extract Base64 signature
4. Verify Ed25519 signature with embedded public key
5. Reject if verification fails

**Key Rotation**:
- Embed primary + backup public keys
- Accept either key during rotation period
- Update app to remove old key after transition

### Network Security

**Configuration** (`network_security_config.xml`):
```xml
<domain-config cleartextTrafficPermitted="false">
    <domain includeSubdomains="true">github.io</domain>
    <trust-anchors>
        <certificates src="system" />
    </trust-anchors>
</domain-config>
```

- Enforces HTTPS for GitHub Pages
- System CA trust anchors
- Optional: Certificate pinning for github.io

### Data Validation

**Defense in Depth**:
1. JSON syntax validation
2. Schema validation (structure)
3. Broker-level validation (fields, URLs)
4. Signature verification (authenticity)

## ğŸ“¦ Adding a New Broker

### For App Developers

No code changes needed! Brokers are added via the data repo.

### For Data Repo Maintainers

1. **Edit `brokers.json`**:
```json
{
  "name": "NewBroker",
  "server": "newbroker-live",
  "platform": "MT5",
  "webTerminalUrl": "https://trade.mql5.com/trade?servers=NewBroker-Live",
  "description": "NewBroker Live Trading",
  "demo": false
}
```

2. **Commit and Push**:
```bash
git add brokers.json
git commit -m "Add NewBroker to catalog"
git push origin main
```

3. **Automated Process**:
   - Workflow validates JSON
   - Signs with Ed25519
   - Deploys to GitHub Pages
   - Users receive update within 7 days (or on manual refresh)

## ğŸ§ª Testing

### Unit Tests

Test coverage should include:

```kotlin
// Broker model
@Test fun `broker validates required fields`()
@Test fun `broker requires https url`()

// Schema validation
@Test fun `schema rejects empty list`()
@Test fun `schema validates all fields`()

// Signature verification
@Test fun `verify accepts valid signature`()
@Test fun `verify rejects invalid signature`()

// Catalog loader
@Test fun `loadEmbedded returns non-empty list`()
@Test fun `loadCached handles missing file`()
```

### Integration Tests

```kotlin
@Test fun `fetchAndVerify handles network error`()
@Test fun `fetchAndVerify rejects tampered data`()
@Test fun `update workflow persists cache`()
```

### Manual Testing

1. **Offline Mode**:
   - Disable network
   - Open broker selection
   - Verify embedded list loads

2. **Update Flow**:
   - Enable network
   - Trigger manual update
   - Check cache timestamp

3. **Signature Tampering**:
   - Modify cached `brokers.json`
   - Trigger update
   - Verify cache is replaced (not rejected)

## ğŸš€ Deployment Checklist

Before releasing broker catalog feature:

- [ ] Generate production Ed25519 keypair
- [ ] Add public key to `SignatureVerifier.kt`
- [ ] Store private key in GitHub Secrets
- [ ] Create `QuantumTrader-Pro-data` repository
- [ ] Enable GitHub Pages (source: root, branch: main)
- [ ] Test signature verification with real key
- [ ] Document key rotation procedure
- [ ] Update embedded `brokers.json` with initial list
- [ ] Test all fallback scenarios
- [ ] Add monitoring for catalog updates

## ğŸ“š API Reference

### BrokerCatalog

```kotlin
val catalog = BrokerCatalog(context)

// Synchronous load (UI thread safe)
val brokers: List<Broker> = catalog.loadCatalog()

// Asynchronous update (use in coroutine)
lifecycleScope.launch {
    val updated: List<Broker>? = catalog.fetchAndVerify()
    if (updated != null) {
        // Update UI
    }
}
```

### BrokerUpdateManager

```kotlin
val updateManager = BrokerUpdateManager(context)

// Enable auto-updates
updateManager.setAutoUpdateEnabled(true)

// Manual update
val workRequest = updateManager.updateNow()
WorkManager.getInstance(context)
    .getWorkInfoByIdLiveData(workRequest.id)
    .observe(this) { workInfo ->
        when (workInfo.state) {
            WorkInfo.State.SUCCEEDED -> showSuccess()
            WorkInfo.State.FAILED -> showError()
        }
    }
```

## ğŸ”§ Configuration

### Build Configuration

```gradle
// app/build.gradle
android {
    buildFeatures {
        buildConfig = true
    }
}

// Generate BuildConfig fields for URLs
defaultConfig {
    buildConfigField "String", "BROKER_CATALOG_URL",
        "\"https://dezirae-stark.github.io/QuantumTrader-Pro-data/brokers.json\""
}
```

### Runtime Configuration

All settings in `BrokerCatalogConfig`:

```kotlin
const val BASE_URL = "https://dezirae-stark.github.io/QuantumTrader-Pro-data"
const val CATALOG_URL = "$BASE_URL/brokers.json"
const val SIGNATURE_URL = "$BASE_URL/brokers.json.sig"
const val CONNECT_TIMEOUT_MS = 15000L
const val READ_TIMEOUT_MS = 15000L
const val CACHE_EXPIRATION_MS = 7L * 24 * 60 * 60 * 1000  // 1 week
const val MIN_UPDATE_INTERVAL_MS = 60L * 60 * 1000  // 1 hour
```

## ğŸ“ Support

- **Code Issues**: Open issue in main repo
- **Catalog Updates**: PR to `QuantumTrader-Pro-data`
- **Security Concerns**: See `SECURITY.md`

---

**Last Updated**: 2025-11-12
**Architecture Version**: 1.0
