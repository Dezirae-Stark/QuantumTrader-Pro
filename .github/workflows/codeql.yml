name: "CodeQL Security Analysis"

on:
  push:
    branches: [ main, desktop, security/* ]
  pull_request:
    branches: [ main ]
  schedule:
    # Run at 6:00 AM UTC every Monday
    - cron: '0 6 * * 1'
  workflow_dispatch:

permissions:
  actions: read
  contents: read
  security-events: write

jobs:
  analyze-java-kotlin:
    name: Analyze Java/Kotlin (Android)
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
    - name: Harden Runner
      uses: step-security/harden-runner@v2
      with:
        egress-policy: audit

    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: 'gradle'

    - name: Set up Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.19.0'
        channel: 'stable'
        cache: true

    - name: Install Flutter dependencies
      run: flutter pub get

    - name: Initialize CodeQL
      uses: github/codeql-action/init@v3
      with:
        languages: java-kotlin
        # Auto-detect Java source in android/ directory
        queries: +security-extended,security-and-quality

    - name: Build Android project
      run: |
        # Build the Android project to generate bytecode for analysis
        cd android
        ./gradlew assembleDebug --no-daemon --stacktrace

    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v3
      with:
        category: "/language:java-kotlin"
        upload: true

  analyze-javascript:
    name: Analyze JavaScript/TypeScript
    runs-on: ubuntu-latest
    timeout-minutes: 20

    # Only run if JavaScript/TypeScript files exist
    steps:
    - name: Harden Runner
      uses: step-security/harden-runner@v2
      with:
        egress-policy: audit

    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Check for JS/TS files
      id: check-js
      run: |
        if [ -f "package.json" ] || [ -f "bridge/package.json" ]; then
          echo "has_js=true" >> $GITHUB_OUTPUT
        else
          echo "has_js=false" >> $GITHUB_OUTPUT
        fi

    - name: Set up Node.js
      if: steps.check-js.outputs.has_js == 'true'
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install dependencies
      if: steps.check-js.outputs.has_js == 'true'
      run: |
        if [ -f "package.json" ]; then
          npm ci
        elif [ -f "bridge/package.json" ]; then
          cd bridge && npm ci
        fi

    - name: Initialize CodeQL
      if: steps.check-js.outputs.has_js == 'true'
      uses: github/codeql-action/init@v3
      with:
        languages: javascript-typescript
        queries: +security-extended,security-and-quality

    - name: Perform CodeQL Analysis
      if: steps.check-js.outputs.has_js == 'true'
      uses: github/codeql-action/analyze@v3
      with:
        category: "/language:javascript-typescript"
        upload: true

    - name: Skip JS analysis
      if: steps.check-js.outputs.has_js == 'false'
      run: echo "No JavaScript/TypeScript files detected - skipping analysis"

  security-summary:
    name: Security Analysis Summary
    runs-on: ubuntu-latest
    needs: [analyze-java-kotlin, analyze-javascript]
    if: always()

    steps:
    - name: Check analysis results
      run: |
        echo "üìä CodeQL Security Analysis Complete"
        echo ""
        echo "‚úÖ Java/Kotlin Analysis: ${{ needs.analyze-java-kotlin.result }}"
        echo "‚úÖ JavaScript Analysis: ${{ needs.analyze-javascript.result }}"
        echo ""
        echo "üîç View detailed results in the Security tab:"
        echo "   https://github.com/${{ github.repository }}/security/code-scanning"
        echo ""

        if [ "${{ needs.analyze-java-kotlin.result }}" = "failure" ] || [ "${{ needs.analyze-javascript.result }}" = "failure" ]; then
          echo "‚ö†Ô∏è  Some analyses failed - check workflow logs"
          exit 1
        fi
