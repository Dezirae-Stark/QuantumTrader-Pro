name: Security Scan (Scheduled)

# Scheduled security scans to detect vulnerabilities and secrets
# Runs weekly on Monday at 00:00 UTC
on:
  schedule:
    # Every Monday at 00:00 UTC
    - cron: '0 0 * * 1'
  workflow_dispatch:
  pull_request:
    branches: [main]
    paths:
      - '**.dart'
      - '**.gradle'
      - '**.yml'
      - '**.yaml'
      - 'pubspec.yaml'
      - 'pubspec.lock'

jobs:
  # Job 1: Secret Scanning with Gitleaks
  gitleaks:
    name: Secret Scanning
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}

      - name: Gitleaks summary
        if: success()
        run: |
          echo "‚úÖ No secrets detected by Gitleaks"
          echo ""
          echo "Scanned for:"
          echo "  - API keys"
          echo "  - Passwords"
          echo "  - Private keys"
          echo "  - Tokens"
          echo "  - Credentials"

  # Job 2: Vulnerability Scanning with Trivy
  trivy:
    name: Vulnerability Scanning
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy filesystem scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'table'
          severity: 'CRITICAL,HIGH,MEDIUM'

      - name: Run Trivy SARIF scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

      - name: Trivy summary
        if: success()
        run: |
          echo "‚úÖ No critical vulnerabilities detected"

  # Job 3: Flutter Dependency Audit
  dependency-check:
    name: Dependency Audit
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.19.0'
          channel: 'stable'
          cache: true

      - name: Get dependencies
        run: flutter pub get

      - name: Check for outdated packages
        run: |
          echo "üì¶ Checking for outdated packages..."
          flutter pub outdated || true

      - name: Generate dependency tree
        run: |
          echo "üå≥ Generating dependency tree..."
          flutter pub deps --json > deps.json
          echo ""
          echo "Direct dependencies:"
          flutter pub deps --no-dev | head -30

      - name: Check for pub audit
        run: |
          echo "üîç Running pub audit (if available)..."
          flutter pub audit || echo "‚ö†Ô∏è  pub audit not available in Flutter 3.19.0"

      - name: Dependency summary
        run: |
          echo "‚úÖ Dependency check completed"
          echo ""
          echo "üìä Statistics:"
          echo "  Total packages: $(grep -c '"name":' deps.json || echo 'unknown')"

  # Job 4: Code Quality Analysis
  code-quality:
    name: Code Quality Analysis
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.19.0'
          channel: 'stable'
          cache: true

      - name: Get dependencies
        run: flutter pub get

      - name: Run code generation
        run: |
          echo "üî® Generating code..."
          dart run build_runner build --delete-conflicting-outputs || echo "‚ö†Ô∏è  Code generation failed"

      - name: Run Flutter analyze
        run: |
          echo "üîç Running static analysis..."
          flutter analyze || echo "‚ö†Ô∏è  Analysis found issues"

      - name: Check code formatting
        run: |
          echo "üíÖ Checking code formatting..."
          dart format --set-exit-if-changed . || echo "‚ö†Ô∏è  Code formatting issues found"

      - name: Code quality summary
        run: |
          echo "‚úÖ Code quality check completed"

  # Job 5: Summary Report
  summary:
    name: Security Scan Summary
    runs-on: ubuntu-latest
    needs: [gitleaks, trivy, dependency-check, code-quality]
    if: always()

    steps:
      - name: Generate summary
        run: |
          echo "========================================="
          echo "üîí Security Scan Summary"
          echo "========================================="
          echo ""
          echo "Jobs completed:"
          echo "  - Gitleaks (secrets): ${{ needs.gitleaks.result }}"
          echo "  - Trivy (vulnerabilities): ${{ needs.trivy.result }}"
          echo "  - Dependency audit: ${{ needs.dependency-check.result }}"
          echo "  - Code quality: ${{ needs.code-quality.result }}"
          echo ""

          if [ "${{ needs.gitleaks.result }}" = "success" ] && \
             [ "${{ needs.trivy.result }}" = "success" ] && \
             [ "${{ needs.dependency-check.result }}" = "success" ] && \
             [ "${{ needs.code-quality.result }}" = "success" ]; then
            echo "‚úÖ All security scans passed!"
          else
            echo "‚ö†Ô∏è  Some scans failed or were skipped"
          fi

      - name: Failure notification
        if: failure()
        run: |
          echo "‚ùå Security scan pipeline failed!"
          echo ""
          echo "Please review the failed jobs above."
          echo "Fix any issues before merging to main or releasing."
