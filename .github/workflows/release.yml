name: Release Build

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v2.1.0)'
        required: true
        type: string

jobs:
  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    outputs:
      upload_url: ${{ steps.create_release.outputs.upload_url }}
      version: ${{ steps.get_version.outputs.version }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Get version
      id: get_version
      run: |
        if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
          echo "version=${{ inputs.version }}" >> $GITHUB_OUTPUT
        else
          echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
        fi

    - name: Generate changelog
      id: changelog
      run: |
        # Get commits since last tag
        LAST_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
        if [ -z "$LAST_TAG" ]; then
          COMMITS=$(git log --pretty=format:"- %s (%h)" --reverse)
        else
          COMMITS=$(git log ${LAST_TAG}..HEAD --pretty=format:"- %s (%h)" --reverse)
        fi

        echo "changelog<<EOF" >> $GITHUB_OUTPUT
        echo "$COMMITS" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT

    - name: Create Release
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.get_version.outputs.version }}
        release_name: QuantumTrader Pro ${{ steps.get_version.outputs.version }}
        body: |
          ## QuantumTrader Pro ${{ steps.get_version.outputs.version }}

          ### Changes
          ${{ steps.changelog.outputs.changelog }}

          ### Downloads
          - **Linux**: quantumtrader-pro-linux-x64.tar.gz
          - **Windows**: quantumtrader-pro-windows-x64.zip
          - **macOS**: quantumtrader-pro-macos-universal.zip

          ### Installation
          See [BUILD_GUIDE.md](https://github.com/Dezirae-Stark/QuantumTrader-Pro/blob/main/BUILD_GUIDE.md) for installation instructions.

          ### Documentation
          - [README.md](https://github.com/Dezirae-Stark/QuantumTrader-Pro/blob/main/README.md)
          - [ARCHITECTURE.md](https://github.com/Dezirae-Stark/QuantumTrader-Pro/blob/main/ARCHITECTURE.md)
          - [PROJECT_STRUCTURE.md](https://github.com/Dezirae-Stark/QuantumTrader-Pro/blob/main/PROJECT_STRUCTURE.md)
        draft: false
        prerelease: false

  build-linux:
    name: Build Linux Release
    runs-on: ubuntu-latest
    needs: create-release

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.24.5'
        channel: 'stable'

    - name: Install Linux dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y clang cmake ninja-build pkg-config libgtk-3-dev liblzma-dev

    - name: Get dependencies
      run: flutter pub get

    - name: Build Linux app
      run: flutter build linux --release

    - name: Package Linux app
      run: |
        cd build/linux/x64/release/bundle
        tar -czf quantumtrader-pro-linux-x64.tar.gz *
        mv quantumtrader-pro-linux-x64.tar.gz ../../../../../../

    - name: Upload Release Asset
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ needs.create-release.outputs.upload_url }}
        asset_path: ./quantumtrader-pro-linux-x64.tar.gz
        asset_name: quantumtrader-pro-linux-x64-${{ needs.create-release.outputs.version }}.tar.gz
        asset_content_type: application/gzip

  build-windows:
    name: Build Windows Release
    runs-on: windows-latest
    needs: create-release

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.24.5'
        channel: 'stable'

    - name: Get dependencies
      run: flutter pub get

    - name: Build Windows app
      run: flutter build windows --release

    - name: Package Windows app
      run: |
        Compress-Archive -Path build/windows/x64/runner/Release/* -DestinationPath quantumtrader-pro-windows-x64.zip

    - name: Upload Release Asset
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ needs.create-release.outputs.upload_url }}
        asset_path: ./quantumtrader-pro-windows-x64.zip
        asset_name: quantumtrader-pro-windows-x64-${{ needs.create-release.outputs.version }}.zip
        asset_content_type: application/zip

  build-macos:
    name: Build macOS Release
    runs-on: macos-latest
    needs: create-release

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.24.5'
        channel: 'stable'

    - name: Get dependencies
      run: flutter pub get

    - name: Build macOS app
      run: flutter build macos --release

    - name: Package macOS app
      run: |
        cd build/macos/Build/Products/Release
        zip -r quantumtrader-pro-macos-universal.zip quantumtrader_pro.app
        mv quantumtrader-pro-macos-universal.zip ../../../../../../

    - name: Upload Release Asset
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ needs.create-release.outputs.upload_url }}
        asset_path: ./quantumtrader-pro-macos-universal.zip
        asset_name: quantumtrader-pro-macos-universal-${{ needs.create-release.outputs.version }}.zip
        asset_content_type: application/zip
