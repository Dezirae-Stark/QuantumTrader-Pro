name: Flutter Desktop Build

on:
  push:
    branches: [ main, desktop ]
    paths:
      - 'lib/**'
      - 'android/**'
      - 'assets/**'
      - 'pubspec.yaml'
      - '.github/workflows/flutter-desktop-build.yml'
  pull_request:
    branches: [ main, desktop ]
    paths:
      - 'lib/**'
      - 'android/**'
      - 'assets/**'
      - 'pubspec.yaml'
  workflow_dispatch:

jobs:
  build-linux:
    name: Build Linux
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.24.5'
        channel: 'stable'
        cache: true

    - name: Install Linux dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y clang cmake ninja-build pkg-config libgtk-3-dev liblzma-dev

    - name: Flutter doctor
      run: flutter doctor -v

    - name: Get dependencies
      run: flutter pub get

    - name: Run tests
      run: flutter test

    - name: Build Linux app
      run: flutter build linux --release
      continue-on-error: true

    - name: Package Linux app
      run: |
        cd build/linux/x64/release/bundle
        tar -czf quantumtrader-pro-linux-x64.tar.gz *
        mv quantumtrader-pro-linux-x64.tar.gz ../../../../../../
      continue-on-error: true

    - name: Upload Linux artifact
      uses: actions/upload-artifact@v4
      with:
        name: quantumtrader-pro-linux-x64
        path: quantumtrader-pro-linux-x64.tar.gz
        retention-days: 30

  build-windows:
    name: Build Windows
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.24.5'
        channel: 'stable'
        cache: true

    - name: Flutter doctor
      run: flutter doctor -v

    - name: Get dependencies
      run: flutter pub get

    - name: Run tests
      run: flutter test

    - name: Build Windows app
      run: flutter build windows --release
      continue-on-error: true

    - name: Package Windows app
      run: |
        Compress-Archive -Path build/windows/x64/runner/Release/* -DestinationPath quantumtrader-pro-windows-x64.zip
      continue-on-error: true

    - name: Upload Windows artifact
      uses: actions/upload-artifact@v4
      with:
        name: quantumtrader-pro-windows-x64
        path: quantumtrader-pro-windows-x64.zip
        retention-days: 30

  build-macos:
    name: Build macOS
    runs-on: macos-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.24.5'
        channel: 'stable'
        cache: true

    - name: Flutter doctor
      run: flutter doctor -v

    - name: Get dependencies
      run: flutter pub get

    - name: Run tests
      run: flutter test

    - name: Build macOS app
      run: flutter build macos --release
      continue-on-error: true

    - name: Package macOS app
      run: |
        cd build/macos/Build/Products/Release
        zip -r quantumtrader-pro-macos-universal.zip quantumtrader_pro.app
        mv quantumtrader-pro-macos-universal.zip ../../../../../../
      continue-on-error: true

    - name: Upload macOS artifact
      uses: actions/upload-artifact@v4
      with:
        name: quantumtrader-pro-macos-universal
        path: quantumtrader-pro-macos-universal.zip
        retention-days: 30

  build-status:
    name: Build Status
    runs-on: ubuntu-latest
    needs: [build-linux, build-windows, build-macos]
    if: always()

    steps:
    - name: Check build status
      run: |
        echo "Linux: ${{ needs.build-linux.result }}"
        echo "Windows: ${{ needs.build-windows.result }}"
        echo "macOS: ${{ needs.build-macos.result }}"

        if [ "${{ needs.build-linux.result }}" == "success" ] && \
           [ "${{ needs.build-windows.result }}" == "success" ] && \
           [ "${{ needs.build-macos.result }}" == "success" ]; then
          echo "✓ All desktop builds successful"
          exit 0
        else
          echo "✗ Some builds failed"
          exit 1
        fi
