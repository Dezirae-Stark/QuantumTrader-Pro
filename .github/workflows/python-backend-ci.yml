---
name: Python Backend CI

on:
  push:
    branches: [main, desktop, develop]
    paths:
      - 'backend/**'
      - 'ml/**'
      - 'brokers/**'
      - 'tests/**'
      - 'configs/**'
      - 'schemas/**'
      - 'requirements.txt'
      - '.github/workflows/python-backend-ci.yml'
  pull_request:
    branches: [main, desktop]
    paths:
      - 'backend/**'
      - 'ml/**'
      - 'brokers/**'
      - 'tests/**'
      - 'configs/**'
      - 'schemas/**'
      - 'requirements.txt'

jobs:
  test:
    name: Test Python ${{ matrix.python-version }}
    runs-on: ubuntu-latest
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        python-version: ['3.11', '3.12']

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pytest pytest-cov flake8 jsonschema pyyaml numpy pandas scikit-learn requests

    - name: Lint with flake8
      run: |
        # Stop the build if there are Python syntax errors or undefined names
        flake8 backend ml brokers --count --select=E9,F63,F7,F82 --show-source --statistics
        # Exit-zero treats all errors as warnings. The GitHub editor is 127 chars wide
        flake8 backend ml brokers --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

    - name: Validate JSON schemas
      run: |
        python -c "
        import json
        import os
        from pathlib import Path

        schemas_dir = Path('schemas')
        errors = []

        for schema_file in schemas_dir.glob('*.json'):
            try:
                with open(schema_file, 'r') as f:
                    json.load(f)
                print(f'✓ {schema_file.name} is valid JSON')
            except json.JSONDecodeError as e:
                errors.append(f'{schema_file.name}: {e}')
                print(f'✗ {schema_file.name} has errors: {e}')

        if errors:
            print(f'\n{len(errors)} schema(s) have errors')
            exit(1)
        else:
            print(f'\nAll {len(list(schemas_dir.glob(\"*.json\")))} schemas are valid')
        "

    - name: Validate YAML configuration
      run: |
        python -c "
        import yaml
        from pathlib import Path

        config_file = Path('configs/config.yaml')
        try:
            with open(config_file, 'r') as f:
                config = yaml.safe_load(f)
            print(f'✓ {config_file} is valid YAML')
            print(f'  Environment: {config.get(\"ENV\", \"not set\")}')
            print(f'  Broker: {config.get(\"BROKER_PROVIDER\", \"not set\")}')
        except Exception as e:
            print(f'✗ {config_file} has errors: {e}')
            exit(1)
        "

    - name: Test with pytest
      run: |
        pytest tests/ -v --cov=backend --cov=ml --cov=brokers --cov-report=xml --cov-report=term

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v4
      if: matrix.python-version == '3.11'
      with:
        file: ./coverage.xml
        flags: backend
        name: backend-coverage
        fail_ci_if_error: false

    - name: Test broker providers
      run: |
        python -c "
        import sys
        sys.path.insert(0, '.')
        from brokers.factory import _BROKER_REGISTRY

        print('Registered broker providers:')
        for name, provider_class in _BROKER_REGISTRY.items():
            print(f'  - {name}: {provider_class.__name__}')

        if len(_BROKER_REGISTRY) == 0:
            print('ERROR: No broker providers registered!')
            exit(1)
        "

    - name: Test prediction postprocessing
      run: |
        python -c "
        import sys
        sys.path.insert(0, '.')
        from ml.postprocessing import (
            is_valid_price,
            enforce_price_sanity,
            sanitize_predictions
        )

        # Test basic validation
        assert is_valid_price(1.0850) == True
        assert is_valid_price(-1.5) == False
        assert is_valid_price(0) == False

        # Test price sanity
        price = enforce_price_sanity(1.0850, 'EURUSD')
        assert price == 1.0850

        # Test negative price handling
        price = enforce_price_sanity(-1.5, 'EURUSD', fallback_price=1.0800)
        assert price == 1.0800

        print('✓ All postprocessing validation tests passed')
        "

  security:
    name: Security Scan
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Run Gitleaks
      uses: gitleaks/gitleaks-action@v2
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}

    - name: Python Security Check
      run: |
        pip install safety
        # Check for known security vulnerabilities in dependencies
        pip freeze | safety check --stdin || true

  build-status:
    name: Build Status Check
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: [test, security]
    if: always()

    steps:
    - name: Check build status
      run: |
        if [ "${{ needs.test.result }}" == "success" ] && [ "${{ needs.security.result }}" == "success" ]; then
          echo "✓ All checks passed"
          exit 0
        else
          echo "✗ Some checks failed"
          echo "Test result: ${{ needs.test.result }}"
          echo "Security result: ${{ needs.security.result }}"
          exit 1
        fi
